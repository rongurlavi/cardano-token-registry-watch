name: Watch Cardano Token Registry

on:
  schedule:
    - cron: "0 * * * *"     # every hour
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-new-tokens:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Run check_new_tokens and capture output
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LOOKBACK_HOURS: "24"
        run: |
          # Run the Python script and capture its full output
          OUTPUT="$(python check_new_tokens.py)"
          echo "$OUTPUT"

          # Expose the full output as a multi-line job output
          echo "full_message<<EOF" >> "$GITHUB_OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # Default values
          echo "has_new=false" >> "$GITHUB_OUTPUT"
          echo "count=0" >> "$GITHUB_OUTPUT"

          # Count tokens (each token line starts with "- ")
          COUNT=$(echo "$OUTPUT" | grep -E "^-" | wc -l | tr -d ' ')

          # Timestamp in UTC
          TS=$(date -u +"%Y-%m-%d %H:%M UTC")
          echo "timestamp=$TS" >> "$GITHUB_OUTPUT"

          # Detect alert marker
          if echo "$OUTPUT" | grep -q "ðŸš¨"; then
            echo "has_new=true" >> "$GITHUB_OUTPUT"
            echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub issue for new or updated tokens
        if: steps.check.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const count = ${{ steps.check.outputs.count }};
            const timestamp = `${{ steps.check.outputs.timestamp }}`;
            const body = ${{ toJSON(steps.check.outputs.full_message) }};

            const title = `New or updated Cardano token registry entries detected - ${count} tokens - ${timestamp}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['token-registry', 'automation']
            });

      - name: Slack notification for new or updated tokens
        if: steps.check.outputs.has_new == 'true'
        env:
          # for production
          #SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # for testing
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_TEST }}
          SLACK_TEXT: ${{ steps.check.outputs.full_message }}
        run: |
          # Safely JSON-encode the multi-line text for Slack
          payload=$(python - << 'EOF'
          import json, os
          text = os.environ["SLACK_TEXT"]
          print(json.dumps({"text": text}))
          EOF
          )
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
