name: Watch Cardano Token Registry

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-new-tokens:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Run check_new_tokens and capture output
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LOOKBACK_HOURS: "2"
       run: |
          OUTPUT="$(python check_new_tokens.py)"
          echo "$OUTPUT"

          # Expose the full script output as a multi line job output
          echo "full_message<<EOF" >> "$GITHUB_OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # Default: no changes
          echo "has_new=false" >> "$GITHUB_OUTPUT"
          echo "count=0" >> "$GITHUB_OUTPUT"

          # Count lines starting with "-" (one per token)
          COUNT=$(echo "$OUTPUT" | grep -E "^-" | wc -l | tr -d ' ')

          # Timestamp in UTC
          TS=$(date -u +"%Y-%m-%d %H:%M UTC")
          echo "timestamp=$TS" >> "$GITHUB_OUTPUT"

          # If alert marker present, mark as has_new and store count
          if echo "$OUTPUT" | grep -q "ðŸš¨"; then
            echo "has_new=true" >> "$GITHUB_OUTPUT"
            echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          fi

           # IF new tokens found
      - name: Create GitHub issue for new tokens
        if: steps.check.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const count = ${{ steps.check.outputs.count }};
            const timestamp = `${{ steps.check.outputs.timestamp }}`;
            const body = `${{ toJSON(steps.check.outputs.output) }}`;

            const title = `New Cardano token registrations detected - ${count} tokens - ${timestamp}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['token-registry', 'automation']
            });

      - name: Slack notification for new tokens
        if: steps.check.outputs.has_new == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TEXT: ${{ steps.check.outputs.full_message }}
        run: |
          payload=$(python - << 'EOF'
          import json, os
          text = os.environ["SLACK_TEXT"]
          print(json.dumps({"text": text}))
          EOF
          )
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"



      # ELSE no new tokens found  (You can comment this out later)
      # - name: Slack notification - no new tokens found
      #   if: steps.check.outputs.has_new == 'false'
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     TIMESTAMP: ${{ steps.check.outputs.timestamp }}
      #   run: |
      #     text="No new Cardano token registry entries detected - ${TIMESTAMP}"
      #     json_payload=$(printf '{"text":"%s"}' "$text")
      #     curl -X POST -H 'Content-type: application/json' --data "$json_payload" "$SLACK_WEBHOOK_URL"
